# 一、数据包的格式

![网络层的格式](https://github.com/healthyxj/computer-network/blob/main/img/%E7%BD%91%E7%BB%9C%E5%B1%82%E7%9A%84%E6%A0%BC%E5%BC%8F.jpg)

数据包由首部、数据两部分组成。数据包的首部由**固定部分(20字节)和可变部分**组成。数据部分很多时候是由传输层传递下来的数据段(Segment)。这里主要介绍首部的各个部分

## 1、版本(version)

版本占4位，分为**IPv4和IPv6.分别用0b0100和0b0110**表示。

## 2、首部长度(Header Length)

**首部长度占4位**，通常要乘以4才表示最终长度。

如0b0101表示20(最小值)，0b1111表示60(最大值)

## 3、区分服务(Differetiated Services Field)

区分服务占8位，主要是用于提高网络服务质量(Qos,Quality of Service)

## 4、总长度

**占16位**，是首部和数据的长度之和，最大值为65535.

因为帧的数据部分长度不能超过1500字节，**过大的IP数据包，需要分成片(Fragments)**传输给数据链路层。每一片都有自己的网络层首部(IP首部)

## 5、标识(identification)

占16位，有一个计数器专门管理数据包的ID，每发出一个数据包，ID就加1.数据包的ID，当数据包过大**进行分片时，同一个数据包的所有片的标识都是一样的**

## 6、标志(flags)

占3位，

* 第一位：Reserved Bit,保留
* 第二位：Don' t Fragment,1代表不允许分片，0代表允许分片
* 第三位：More Fragment，1代表不是最后一片，0代表是最后一片

~~~
ping的用法
ping /?
查看ping的用法

ping ip地址 -l 数据包大小
发送指定大小的数据包

ping ip地址 -f
不允许网络层分片

ping ip地址 -i TTL
设置TTL的值

通过tracert、pathping命令，可以跟踪数据包经过了哪些路由器
~~~

这里可以用ping course.zju.edu.cn来试试，在wireshark中打开，搜索ip.addr == course.zju.edu.cn,可以在Internet Protocol下查看相关信息

## 7、片偏移(Fragment Offset)

占13位，片偏移*8表示字节偏移。

**片偏移用于分片的数据包中，0-1499，1500-2999**.

## 8、生存时间(Time To Live,TTL)

占8位，每个**路由器在转发之前会将TTL减1**，一旦发现**TTL减为0，路由器会返回错误报告**，防止默认路径导致死循环。观察使用**ping命令后的TTL，能够推测出对方的操作系统**、中间**经过了多少个路由器**，以及路由器的设置

windows默认TTL为128，Linux默认TTL为64.

~~~cmd
ping cc98.org -i 1

正在 Ping cc98.org [192.64.119.35] 具有 32 字节的数据:
来自 10.0.2.71 的回复: TTL 传输中过期。
来自 10.0.2.71 的回复: TTL 传输中过期。
来自 10.0.2.71 的回复: TTL 传输中过期。
来自 10.0.2.71 的回复: TTL 传输中过期。

192.64.119.35 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
    
这里应该是第一台路由器返回的消息，因此第一台路由器的网关为10.0.2.71
更简便的方法是tracert IP地址
~~~

## 9、协议

占八位，表明所封装的数据使用了什么协议

| 协议       | ICMP | IGMP | IP   | TCP  | EGP  | IGP  | UDP  | IPv6 | ESP  | OSPF |
| ---------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 值(十进制) | 1    | 2    | 4    | 6    | 8    | 9    | 17   | 41   | 50   | 89   |

## 10、首部校验和(Header CheckSum)

用于检查首部是否有错误
