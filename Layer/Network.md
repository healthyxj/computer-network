~~~
数据平面需要掌握
网络层服务模型
转发vs路由
路由器如何工作
寻址
广义路由
网络结构

控制平面需要掌握
传统路由算法
SDN控制器
网络管理，配置
OSPF, BGP
OpenFlow, ODL ONOS控制器
ICMP
SNMP，NETCONF
~~~



# 0、网络层概述

## 1、虚电路和数据报服务

虚电路服务

建立虚电路(virtual circuit)，保证双方通信所需要的一切网络资源。**虚电路只是一条逻辑上的连接，即虚电路服务是有连接的**，分组沿着逻辑连接按照存储转发的方式传送。

数据报服务

网络层只向上提供简单、**无连接的尽最大努力交付**的数据报服务。每一个分组(IP数据报)独立发送，**不进行编号**。不承诺提供服务的质量，传送的分组可能出现出错、丢失和重复。好处是能够降低网络的造价。可靠通信由用户主机来实现。

## 2、转发和路由选择

将分组从一台主机移动到另一台主机，需要两个重要的网络层功能

### 转发和路由

* 转发
  * 当一个分组到达某路由器的一条输入链路时，该路由器需要将该分组移动到适当的输出链路。
  * **转发(forwarding)**是将分组从一个**输入链路转移到适当的输出链路接口**的路由器**本地**动作
  * 路由表是根据路由选择算法得出的，转发表是根据路由表得出的
* 路由选择
  * 当分组从发送方流向接收方，网络层必须决定这些分组所采用的路由或路径。
  * **路由选择(routing)**是**确定分组从源到目的地所采取的端到端路径**的网络范围处理过程，通常采用软件来实现

每台路由器都有一个关键元素即**转发表(forwarding table)**，路由器检查到达分组首部的一个多个字段值，进而使用这些首部值在转发表中索引。

### 数据平面与控制平面

数据平面是本地的每路由的功能，决定**输入端口到哪个输出端口**；控制平面决定数据报在哪个主机到哪个主机的路径。**每路由控制平面**中，独立的路由器算法在控制平面进行交互；**软件定义网络控制平面**中，远处的控制器计算，在路由器内安装转发表。



传统的方法，**路由选择算法运行在路由器**中，每台路由器都包含转发和路由选择的两种功能。每台路由器中的路由选择算法与其他路由器的路由选择算法相互通信，以计算出转发表的值。

SDN方法，使用该方法，每台路由器都有一个与其他路由器的路由选择组件通信的路由选择组件。这种方法中，**路由器只执行转发，远程控制器计算并分发转发表**。SDN因为是用软件实现的，因此叫做软件定义网络。

### 网络服务模型

网络服务模型(network service model)分组在发送与接收端系统之间的端到端运输特性。网络层提供了**尽力而为服务(best-effort service)**，使用尽力而为服务的缺点：**不能保证发送的分组按照发送顺序被接受；不能保证最终交付；不能保证端到端时延；不能保证最小带宽**。

好处是简单的机制允许因特网被广泛部署；充足的带宽允许实时应用；可以实现分布式的链路层连接；有助于拥塞避免

## 3、路由器工作原理

注意转向网络层的转发功能。

路由器的四个组件

* 输入端口(input port)
  * 终结入物理链路的物理层功能
  * 与入链路远端的链路层进行交互
  * 在输入端口还要执行查找功能
* 输出端口(output port)
* 交换结构
  * 将路由器的输入端口连接到输出端口
  * 是路由器中的网络
* 路由选择处理器
  * 执行控制平面的功能
  * 维护路由选择表和关联链路状态，**为路由器计算转发表**

### 输入端口处理和基于目的转发

输入端口的线路端接功能与链路层处理实现了用于各个输入链路的物理层和链路层。在这个地方，路由器采用转发表查找输入端口，使到达的分组能够经过交换结构转发到该输出端口。

考虑简单的情况，一个入分组基于该分组的目的地址交换到输出端。

转发表

| 前端匹配                   | 链路端口 |
| -------------------------- | -------- |
| 11001000 00010111 0010     | 0        |
| 11001000 00010111 00011000 | 1        |
| 11001000 00010111 00011    | 2        |
| 其他                       | 3        |

路由器用分组目的地址的**前缀(prefix)**与该表中的表项进行匹配。若存在匹配项，就将与该匹配项相关联的链路转发分组。多个匹配时，采取**最长前缀匹配原则(longest prefix matching rule)**。一旦通过查找确定了某分组的输出端口，则该分组就能够发送进入交换结构。

输入端口

分散式交换(decentralized switching).

输出端口



### 交换结构(switch fabrics)

交换结构位于路由器的**核心部位**。

交换可以由许多方式完成

* 经内存交换
  * 速度限制在内存的带宽
* 经总线交换
  * 限制于总线的带宽
* 经互联网络交换

### 输出端口处理

输出端口处理取出已经存放在输出端口内存中的分组并将其发送到输出链路上。包括选择和取出排队的分组进行传输。

### 何处出现排队

无内存可用于存储到达的分组时会出现丢包(packet loss)。

* 输入排队

输入排队交换机中的**线路前部阻塞(Head Of the line， HOL)**。在一个输入队列中排队的分组必须等待通过交换结构发送。

* 输出排队

没有足够的内存来缓存一个分组时，就必须做出决定：丢弃到达的分组(即弃尾，drop-tail)。某些情况下，在缓存填满之前丢弃一个分组是有利的，可以向发送发提供一个拥塞信号。**主动队列管理(Active Queue Management, AQM)**.输出端口的分组调度(packet scheduler)。**缓存容量应该等于平均往返时延(RTT)*链路的容量(C)**

### 分组调度

* 先进先出

FCFS，先进先出；FIFO， 

如果没有足够的缓存空间来容纳到达的分组，队列的分组丢弃策略确定分组是否将被丢弃或者从队列中去除其他分组以便为到达的分组腾出空间。

运行中的FIFO队列。

![](img\路由器工作-FIFO.jpg)

* 优先权排队

priority queuing，到达输出链路的分组被分类放入输出队列中的**优先权类**。**基于IP的实时话音分组**可能获得超过非实时流量的优先权。优先权高先，相同则按照FIFO的方式。

![](img\路由器工作-优先权.jpg)

1分组到达发现链路为空，就开始传输。传输完分组1后，分组3由于优先权高，就先传输。然后是分组2开始传输。在**非抢占式优先权排队**(non-preemptive priority queuing)规则下，一旦分组开始传输，就不能打断。在这种情况下，分组4就等待传输，并在分组2传输完成后开始传输。

* 循环和加权公平排队

在**循环排队规则**(**round robin** queuing discipline)中，在类之间不存在严格的服务优先权。一个**保持工作排队**(work-conserving queuing)规则是在有分组排队等待传输时，不允许链路保持空闲。当寻找给定类的分组没有找到时，保持工作的循环规则就会立即检查循环序列中的下一类。

![](img\路由器工作-两类循环队列.jpg)

分组1、2、4属于同一个分组，分组3、5属于同一个分组。首先，分组1一旦到达就会立即开始传输。分组1结束后，链路调度器就会查找2类的分组，即3，分组3就会开始传输。然后再查找1类的分组，即分组2开始传输。

一种通用的循环排队已经广泛地实现在路由器中，即**加权公平排队**(Weighted Fair Queuing, **WFQ**)。WFQ也为每个类提供服务，首先服务第一类，然后服务第二类，最后服务第三类。

# 一、IP协议

与IP协议配套的有

* **地址解析协议(ARP**,address resolution protocol)
  * IP地址经过ARP协议转换为物理地址
* 逆地址解析协议(RARP,reverse address resolution protocol)
  * 物理地址经RARP转换为IP地址
* 网际控制报文协议ICMP
* 网际组管理协议IGMP

IP 地址 ::= { <网络号>, <主机号>}

::=表示定义为

## 中间设备

中间设备又称为中间系统和中继(relay)系统。

常见的中间设备有

* 物理层中继系统：转发器(repeater)
* 数据链路层中继系统：网桥或桥接器(bridge) 
* 网络层中继系统：路由器(router)
* 网桥和路由器的混合物：桥路器(brouter)
* 网络层以上的中继系统：网关(gateway)

在数据链路层及以下的中继系统只是将网络的范围扩大了。

在中间设备中的信息传输均为间接交付，只有最后一步才是直接交付。

## ARP协议

不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用**硬件地址**。

每个主机都有一个**ARP的高速缓存**，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。

当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。如有，就可查出其对应的硬件地址，再将此硬件地址写入MAC 帧，然后通过 46 局域网将该 MAC 帧发往此硬件地址。

为了减少网络上的通信量，主机 A 在发送其 **ARP 请求**分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。

## 网际控制报文协议ICMP

ICMP允许主机或路由器**报告差错情况**和提供有关**异常情况**的报告

ICMP的报文种类有两种，ICMP差错报文和ICMP询问报文。前四个字节格式统一，为**类型、代码和检验和**。

* ICMP差错报文
  * 终点不可达 
  * 源点抑制(Source quench) 
  * 时间超过 
  * 参数问题 
  * 改变路由（重定向）(Redirect)
  * 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文
* ICMP询问报文
  * 回送请求和回答报文 
  * 时间戳请求和回答报文



## 无分类域间路由选择(CIDR)

Class Inter-Domain Routing

使用了各种长度的网络前缀(network prefix)来代替分类地址中的网络号和子网号。

要选择**最长前缀匹配**

# 二、数据包的格式

![网络层的格式](img\网络层的格式.jpg)

数据包由首部、数据两部分组成。数据包的首部由**固定部分(20字节)和可变部分**组成。数据部分很多时候是由传输层传递下来的数据段(Segment)。这里主要介绍首部的各个部分

## 1、版本(version)

版本占4位，分为**IPv4和IPv6.分别用0b0100和0b0110**表示。

## 2、首部长度(Header Length)

**首部长度占4位**，通常要乘以4才表示最终长度。最小是20，最大可以根据4位二进制位进行推算。一般IP数据报为20字节。

如0b0101表示20(最小值)，0b1111表示60(最大值)

## 3、区分服务(Differetiated Services Field)

区分服务占8位，主要是用于提高网络服务质量(Qos,Quality of Service)

## 4、总长度

**占16位**，是**首部和数据的长度之和**，最大值为65535.

因为帧的数据部分长度不能超过1500字节(实际是1480 = 1500 - 20)，**过大的IP数据包，需要分成片(Fragments)**传输给数据链路层。每一片都有自己的网络层首部(IP首部)

## 5、标识(identification)

占16位，有一个计数器专门管理数据包的ID，每发出一个数据包，ID就加1.数据包的ID，当数据包过大**进行分片时，同一个数据包的所有片的标识都是一样的**

## 6、标志(flags)

占3位，

* 第一位：Reserved Bit,保留
* 第二位：Don' t Fragment(DF),1代表不允许分片，0代表允许分片
* **第三位：More Fragment(MF)**，1代表不是最后一片，0代表是最后一片

~~~
ping的用法
ping /?
查看ping的用法

ping ip地址 -l 数据包大小
发送指定大小的数据包

ping ip地址 -f
不允许网络层分片

ping ip地址 -i TTL
设置TTL的值

通过tracert、pathping命令，可以跟踪数据包经过了哪些路由器
~~~

这里可以用ping course.zju.edu.cn来试试，在wireshark中打开，搜索ip.addr == course.zju.edu.cn,可以在Internet Protocol下查看相关信息

## 7、片偏移(Fragment Offset)

占13位，片偏移*8表示字节偏移，以**8字节**为偏移单位。

**片偏移用于分片的数据包中，0-1499，1500-2999**.

## 8、生存时间(Time To Live,TTL)

占8位，每个**路由器在转发之前会将TTL减1**，一旦发现**TTL减为0，路由器会返回错误报告**，防止默认路径导致死循环。IPv6不允许在路由器上对分组分片。观察使用**ping命令后的TTL，能够推测出对方的操作系统**、中间**经过了多少个路由器**，以及路由器的设置

windows默认TTL为128，Linux默认TTL为64.

~~~cmd
ping cc98.org -i 1

正在 Ping cc98.org [192.64.119.35] 具有 32 字节的数据:
来自 10.0.2.71 的回复: TTL 传输中过期。
来自 10.0.2.71 的回复: TTL 传输中过期。
来自 10.0.2.71 的回复: TTL 传输中过期。
来自 10.0.2.71 的回复: TTL 传输中过期。

192.64.119.35 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
    
这里应该是第一台路由器返回的消息，因此第一台路由器的网关为10.0.2.71
更简便的方法是tracert IP地址
~~~

## 9、协议

占八位，表明IP数据报的数据部分应该**交给哪个特定的运输层协议**。协议号是将网络层与运输层绑定到一起的粘合剂。

| 协议       | ICMP | IGMP | IP   | TCP   | EGP  | IGP  | UDP    | IPv6 | ESP  | OSPF |
| ---------- | ---- | ---- | ---- | ----- | ---- | ---- | ------ | ---- | ---- | ---- |
| 值(十进制) | 1    | 2    | 4    | **6** | 8    | 9    | **17** | 41   | 50   | 89   |

## 10、首部校验和(Header CheckSum)

用于检查首部是否有错误。

将首部中的每两个字节当作一个数，用反码算数对这些数求和。该和的反码存放在检验和字段中。如果首部中的检验和与计算得到的检验和不一致，就表示出错了。

## 11、源和目的IP地址

源IP字段中插入它的IP地址，在目的IP地址字段中插入最终目的地址。

## 12、选项

该字段允许IP首部被扩展。

## 13、数据(有效载荷)

IP数据报存在的首要理由，IP数据报中的数据字段包含要交付到目的地的运输层的报文。



---


# 三、IPv4编址

## 1、DHCP协议

**动态主机配置协议**(Dynamic Host Configuration Protocol)，可以为本组织内的主机与路由器接口逐个分配IP地址。因为有将主机连接到一个网络的自动能力，因此称为**即插即用协议**(plug and play protocol)或零配置协议(zeroconf)，

详见Application

## 2、网络地址转换

Network Address Translation, NAT

具有专用网络(private network)或具有专用地址的地域(realm with private), 即地址只对该网络中的设备有意义的网络。私网

NAT使能路由器对于外部世界像是一个具有**单一IP地址的单一设备**。NAT使能路由器对外部隐藏了家庭网络的细节。NAT路由器会使用NAT转换表，在表项中包含端口号以及IP地址。

NAT有争议

# 四、IPv6

下一代网际协议ipng

最主要的问题就是 32 位的 IP 地址不够用。

要解决 IP 地址耗尽的问题的措施：

* 采用**无类别域间路由CIDR**， IP地址分配更合理
* **网络地址转换NAT方法**节省全球的IP地址
* 采用具有更大地址空间的新版本的IP地址IPv6

## 1、基本首部

IPv6 仍支持无连接的传送所引进的主要变化如下 

* 更大的地址空间。
  * IPv6 将地址从 IPv4 的 **32 位 增大到了 128 位**。 引入了任播地址(anycast address)，可以将数据报交付给一组主机中任意一个。
* 扩展的地址层次结构。 
* 灵活的首部格式。
  * **40字节长的定首部**允许路由器更快地处理路由器的信息。 
  * **将版本号设置为4，不能创立一个IPv4的数据报**
* 改进的选项。 
* 允许协议继续扩充。 
* 支持**即插即用（即自动配置） **
* 支持资源的预分配

IPv6 将**首部长度变为固定的 40 字节**，称为**基本首部(base header)**。 将不必要的功能取消了，首部的字段数减少到只有 8 个。 **取消了首部的检验和字段，不允许在中间路由器上进行分片和重新组装，也没有选项**，加快了路由器处理数据报的速度。 在基本首部的后面允许有零个或多个扩展首部。 所有的**扩展首部和数据**合起来叫做数据报的**有效载荷(payload)或净负荷**。

![](img\IPv6格式.jpg)

**通信量类(traffic class)**，有8位，为了区分不同IPv6数据报的类别和**优先级**。

流标号(flow label)，有20位，流是互联网上从特定源点到特定终点的一系列数据报，**所有属于同一个流的数据报有同样的流标号**。

**跳数限制(hop limit)**，有8位，源站在数据报发出时即设定跳数限制，路由器在转发数据包时就会将跳数限制字段中的值减1.**当跳数限制的值为0时，路由器就将该数据报丢弃**。TTL

## 2、扩展首部

IPv6 把原来 IPv4 首部中选项的功能都放在**扩展首部**中，并将扩展首部留给路径**两端的源站和目的站**的主机来处理。

数据报途中经过的路由器都不处理这些扩展首部 （只有一个首部例外，即逐跳选项扩展首部），大大提高了路由器的效率。

 RFC 2460 中定义了六种扩展首部： 

* 逐跳选项 
* 路由选择 
* 分片 
* 鉴别 
* 封装安全有效载荷 
* 目的站选项

IPv6的地址空间，可以使用单播(unicast)、多播(multicast)、任播(anycast)。

## 3、冒号十六进制记法

colon hexadecimal notation

每个 16 位的值用十六进制值表示，各值之间用冒号分隔。**零压缩(zero compression)**，即一连串**连续的零可以为一对冒号所取代**。FF05:0:0:0:0:0:0:B3 -> FF05::B3

## 4、点分十进制记法的后缀

60 位的前缀 12AB00000000CD3 可记为： 12AB:0000:0000:CD30:0000:0000:0000:0000/60

或12AB::CD30:0:0:0:0/60

或12AB:0:0:CD30::/60

## 5、地址空间的分配

IPv6 将 128 位地址空间分为两大部分。

* 第一部分是**可变长度的类型前缀**，定义了地址的目的地
* 第二部分是地址的其余部分，长度也是可变的。

特殊地址

* 未指明地址，这是 16 字节的全 0 地址，可缩写为两个冒号“::” 。这个地址只能为还没有配置到一个标准的 IP 地址的主机当作源地址使用
* 环回地址，0:0:0:0:0:0:0:1,记为::1
* 基于IPv4的地址，前缀为0000 0000保留一小部分地址为IPv4兼容

## 6、地址的转换

向 IPv6 过渡只能采用逐步演进的办法，同时，还必须使新安装的 IPv6 系统能够**向后兼容**。IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由。

### 双协议栈

**双协议栈(dual stack)**是指在完全过渡到 IPv6 之前，使一部分主机（或路由器）装有两个协议栈， 一个 IPv4 和一个 IPv6。

IPv6转IPv4，去掉流标号。IPv4转IPv6，增加一个**空的流标号**

### 隧道(tunneling)

将IPv6数据报封装在IPv4数据报中。

ICMPv6 的报文格式和 IPv4 使用的 ICMP 的相似，即前 4 个字节的字段名称都是一样的。

ICMPv6 将第 5 个字节起的后面部分作为报文主体。

ICMPv6的报文划分为四大类

* 差错报告报文
* 提供信息的报文
* 多播听众发现的报文
* 邻站发现报文

# 控制平面

0、概述

软件定义网络 (SDN) 在**数据平面和控制平面**之间做了明确分割，在一台分离的＂控制器”服务中实现了控制平面功能，该控制器服务与它所控制的路由器的转发组件完全分开并远离。OSPF是一种运行在单一 ISP 的网络中的路由选择算法。BGP 是一种在因特网中用于互联所有网络的路由选择算法，因此常被称为因特网的＂黏合剂＂ 。**数据平面实现的是转发，控制平面实现的是路由**。

完成转发表和流表的计算的可能方法

* 每路由器控制(传统)
  * **每台路由器都包含转发和路由的选择功能**。用于与其他路由的路由选择组件通信，以计算其转发表的值。
* **逻辑集中式控制(软件定义网络)**
  * 远处的控制器计算，并且在每台路由器中安装路由表
  * 通用的＂匹配加动作“抽象允许执行传统的IP转发及其它功能(负载共享、防火墙、NAT)。

# 五、路由选择算法

routing algorithm，目的是从发送方到接收方的过程中**确定一条通过路由器网络的好的路径(等价于路由)**。

可以使用图来形式化的描述路由选择问题。将一条链路的开销看成是给定的。

G = (N, E) N表示结点数，E表示无向边数。如果(x, y)属于E，就称x和y互为邻居。求出最低开销路径。**最短路径问题**。

## 1、分类

global表示是所有路由器有完整的拓扑、链路信息

按算法是集中式还是分散式来划分

* **集中式路由选择算法(centralized routing algorithm)**，采用**全局性(global)**的网络知识计算出从源到目的地之间的最低开销路径。集中式算法有关于连通性和链路开销方面的完整信息，具有全局状态信息的算法称为**链路状态(Link State)算法**。

* **分散式路由选择算法(decentralized routing algorithm)**,路由器以**迭代**、分布的方式计算出最低开销路径。每个节点**仅有与其直接相连链路的开销知识**即可开始工作。**距离向量(Distance-Vector)**算法,因为每个结点维护到网络中所有其他结点的开销。

按算法是静态还是动态来划分

* 静态路由选择算法(static routing algorithm)，路由随时间的变化缓慢，通常由人工进行调整。
* 动态路由选择算法(dynamic routing algorithm),随着**网络流量负载或拓扑**发生变化而改变路由选择路径。

按负载敏感还是负载迟钝进行划分

* 负载敏感算法(load-sensitive algorithm)，链路开销会动态地变化反应底层链路的拥塞水平。
* 负载迟钝算法，当今的因特网路由选择算法(RIP、OSPF、BGP)都是**负载迟钝**的.

## 2、链路状态路由选择算法

**集中的，对于节点来说，网络拓扑、链路开销都是已知的**。

链路状态算法中，网络拓扑和所有的链路开销都是已知的，可以作为LS算法的输入。实践中常由链路状态广播(link state broadcast)。

Dijkstra算法，另一个密切相关的算法是Prim算法。Dijkstra算法是**迭代算法**。**u表示源节点，v表示目的节点。**D(v)、p(v)、N'分别表示**到算法的本次迭代，从源节点到目的结点v的最低开销路径的开销**，从源到v沿着当前最低开销路径的**前一节点**，**节点子集**

~~~c
void init(){
    N' = {u}
    for all nodes v
        if v is a neighbor of u
            then D(v) = c(u, v)
        else D(v) = ∞
}

LOOP
	find w not in N' such that D(w) is a minimum
	add w to N'
	update D(v) for each neighbor v of w and not in N': 
    D(v) = min( D(v), D(w) + c(w, v) )
until N' = N    
~~~

![](img\Dijkstra算法.jpg)

![](img\Dijkstra算法2.jpg)

算法复杂度为O(nlogn)



## 3、距离向量路由选择算法

Distance vector是一种**迭代、异步的和分布式**的算法。

* 分布：每一个节点都要从**一个或多个直接相连邻居**接收某些信息。

* 迭代：此过程要持续到邻居之间无更多信息要交换为止。

* 异步：不要求所有节点之间步伐一致地操作。

bellman-ford方程

dx(y) = minv[c(x, y) + dv(y)]

其中**dx(y)表示从节点x到节点y的最低开销路径**。

如果节点x的距离向量因这个更新步骤而改变，节点x接下来将向它的每个邻居发送其更新后的距离向量。

~~~c
void init(){
    for all destination y in N:
    	Dx(y) = c(x, y) //如果y不是x的邻居，则c(x, y)为无穷大
    for each neighbor w
        Dw(y) = ? for all destinations y in N
    for each neighbor w
        send distance vector Dx = [Dx(y): y in N] to w
}

loop
    wait (until I see a link cost change to some neighbor w or until I receive a distance vector from some neighbor w)
    for each y in N:
		Dx(y) = minv{c(x, y) + Dv(y)}
if Dx(y) changed for any destination y
    send distance vector Dx = [Dx(y): y in N] to all neighbors
forever
~~~

会出现路由选择环路(routing loop),导致链路故障。会增加**毒性逆转(poison reverse)**。如果z通过y路由选择到目的地x，则z将通告y，即z到x的距离是无穷大。y就会一直往x方向传播数据，不会经过z。



DV和LS算法采用互补的方法解决选择计算问题。在DV算法中，每个节点仅与它的直接相连的邻居交谈。

* 报文复杂性。LS算法要求每个节点都知道网络中每条链路的开销，就要求发送O(NE)个报文。
* 收敛速度。LS算法实现是一个要求O(NE)个报文的O(N²)算法，而DV算法收敛较慢，且收敛时会遇到路由选择环路。
* 健壮性。路由器遇到故障，在LS算法路由器会向其连接的链路广播不正确的开销。而LS算法在**路由计算方面是分离**的，有一定的健壮性。DV算法由于是迭代的，健壮性较差(好消息传得快，坏消息传得慢)。

# 六、因特网自治系统内部的路由选择：OSPF

路由器的两个问题

* 规模，路由器数目增多，路由器的开销会增大。
* 管理自治，每个ISP都有自己的路由器网络。ISP通常希望按自己的意愿运行路由器，因此需要组织和管理其网络。

这两个问题都可以通过路由器组织**自治系统(Autonomous System, AS)**来解决。在相同 AS 中的路由器都运行**相同的路由选择算法**并且有彼此的信息。在一个自治系统内运行的路由选择算法叫作**自治系统内部路由选择协议 (in a- autonomous system routing protocol)**

## 开放最短路优先

OSPF

开放(open)，是指路由选择协议规范是公众可用的cisco EIGRP协议。OSPF是一种链路状态协议，使用洪泛链路状态信息和Dijkstra最低开销路径算法。可能会选择将链路权值按与链路容量成反比来设置，从而不鼓励流量使用低带宽链路。

## OSPF的优点

* 安全
  * 仅有受信任的路由器能参与一个AS内的OSPF协议
* 多条相同开销的路径
  * 当到达某目的地的多条路径有相同的开销时，OSPF允许使用多条路径
* 对单播与多播路由选择的综合支持
  * 多播OSPF提供了对OSPF的简单拓展
* 支持在单个AS中的层次结构
  * 主干区域的主要作用是为该 AS 中其他区域之间的流量提供 路由选择 该主干总是包含本 AS 中的所有区域边界路由器、并且可能还包含了 些非边界路由器。

# 七、BGP

分组跨越多个AS进行路由时，需要一个**自治系统间路由选择协议(inter-autonomous system routing protocol)**.在因特网中，所有AS运行相同的AS间路由选择协议，称为**边界网关协议(Broder Gateway Protocol, BGP)**.

## 1、作用

每台路由器具有一张转发表，该转发表在将到达分组转发到出路由器链路的过程中起着主要作用。在BGP中，分组不是路由到一个特定的目的地址，相反是**路由到CIDR化的前缀**，每个前缀表示一个子网或者子网的集合。一台路由器的转发表将具有(x, I)的表项，x是一个前缀，I是路由器的接口之一的接口号。

BGP作为AS间的路由选择协议，提供了

* 从**邻居AS获得前缀的可达性**信息。BGP 允许每个子网向因特网的其余部分通告它的存在
* 确定到该前缀的最好的路由。该路由器将本地运行 BGP 路由选择过程（使用它经过相邻的路由器获得的前缀可达性信息）。该最好的路由将基于策略以及可达性信息来确定

## 2、通告BGP路由信息

对于每个AS，路由器要么是一台**网关路由器(gateway router)**，要么是一台**内部路由器(internal router)**。网关路由器是一台位于 AS 边缘的路由器，它直接连接到在其他 AS 中的一台或多台路由器。**内部路由器仅连接**在它自己 AS 中的主机和路由器。

每条直接连接以及所有通过该连接发送的BGP报文，称为**BGP连接(BGP connection)**。跨越两个AS的BGP称为外部BGP(eBGP)，在相同的AS中的两台路由器之间的BGP会话称为内部BGP连接(iBGP).

## 3、确定最好的路由

当路由器通过BGP连接报告前缀时，它在前缀中包括一些BGP属性(BGP attribute)。两个重要的属性是**AS-PATH和NEXT-HOP**。AS-PATH包含了已经通过的AS列表，当AS通过某一个AS时，就会将该AS添加到AS-PATH中。NEXT-HOP是AS-PATH起始的路由器接口的IP地址。

### 热土都路由选择

hot potato routing

热土豆路由选择的思想是，对于路由器，尽快地将分组送出其AS，**不担心其AS外部到目的地余下部分的开销**。那名字来说，就是烫手的。采用热土豆路由选择协议，对于AS中的两台路由器，可能对相同的前缀选择两条不同的AS路径。

### 路由器选择算法

对于任何给定的目的地的前缀，进入BGP的路由选择算法的输入是到某前缀的所有路由的集合。对于有相同前缀的多条路由，按顺序调用规则，直到只剩下一条路由。

* 路由被指派一个**本地偏好(local prefenrence)**值作为其属性之一。具有最高本地偏好值的路由将会被选择
* 从余下的路由中选择具有**最短AS-PATH**的路由。BGP将使用距离向量算法决定路径，距离测度是AS跳的跳数而不是路由器的跳数。
* 从余下的路由中选择具有**最靠近NEXT-HOP**的路由
* 选择BGP标识符

## 4、IP任播

BGP用于实现**IP任播(anycast)**的功能。该服务通常用于DNS服务中。

在IP任播配置阶段，CDN公司为它的多台服务器指派相同的IP地址，并且使用标准的BGP来通告IP地址。配置路由选择表时，每台路由器将本地化地使用BGP路由选择算法来挑选到达该IP地址的最好的路由。

## 5、路由选择策略

当某路由器选择到目的地的一条路由时， AS 路由选择策略能够胜过所有其他考虑。实际上首先根据本地偏好属性选择路由，**本地偏好属性由本地AS的策略**所确定。

## 6、拼装在一起

小型网络：需要公共web服务器、一台电子邮件服务器和一台DNS服务器。

首先，需要获得互联网连接，需要与**本地ISP**签订合同。有网关路由器，路由器会提供IP地址范围，可以用于分配IP地址。

还需要与**因特网注册机构**签订合同，获得域名。

# 八、SDN控制平面

SDN体系结构有四个关键特征

* 基于流的转发
* 数据平面与控制平面分离
  * 数据平面由网络交换机组成，控制平面由服务器以及决定和管理交换机流表的软件组成
* 网络控制功能位于数据平面交换机外部
  * 控制器维护准确的网络状态信息；并且为控制平面的网络控制应用程序提供这些信息
* 可编程的网络
  * 可以使用由SDN控制器提供的API来定义和控制网络设备中的数据平面

## 1、SDN控制器和SDN网络控制应用程序

SDN控制平面大致分为：SDN控制器和SDN应用程序

控制器的功能大致分为3个层次

* 通信层：SDN控制器和受控网络设备之间的通信
  * SDN要控制远程SDN使能的交换机、主机等其他设备，就需要一个协议来传送控制器与这些设备的信息。**控制器和受控设备**之间的通信跨越了一个接口，被称为控制器的**南向接口**
* 网络范围状态管理层
  * SDN控制平面要求控制器有SDN控制设备的最新状态信息。既然控制平面的终极目标是决定用于各种受控设备的流表，控制器也就可以维护这些表的拷贝
* 对于网络控制应用程序层的接口
  * 控制器通过它的**北向接口与网络控制应用程序**交互。该API允许网络控制应用程序在状态管理层之间读/写网络状态和流表



## 2、OpenFlow协议

运行在TCP之上，使用6653的端口号。

匹配加转发表在openflow中称为流表(flow table)。每个表项包括

* 首部字段值的集合
  * 匹配不上流表项的分组将被丢弃或发送到远程控制处理
* 计数器集合
  * 可以包括已经与该表项匹配的分组数量，以及从表项上次更新的时间

* 动作集合
  * 可以将分组转发到给定的输出端口，丢弃、复制和将他们发送到多个输出端口

### 匹配

openflow的匹配抽象允许对来自三个层次的协议首部所选字段进行匹配。

### 动作

每个流表项有零个或多个动作列表，重要的动作有

* **转发**
  * 可能广播到所有的端口，也可能安装新的流表项
* **丢弃**
  * 没有动作的流表项表明某个匹配的分组应当被丢弃
* **修改字段**
  * 在分组被转发到所选的输出端口之前，分组首部10个字段的值可以重写

从控制器到受控交换机流动的重要报文有

* 配置
  * 该报文允许控制器查询并设置交换机的配置参数
* 修改状态
  * 增加/删除交换机流表中的表项
* 读状态
  * 用于从交换机的流表和端口收集统计数据和计数器值
* 发送分组
* 流删除
  * 通知控制器已删除一个流表项
* 端口状态
  * 向控制器通知端口状态的变化
* 分组入
  * 匹配的分组将被发送给控制器



# 九、ICMP

**因特网控制报文协议**，用于**主机和路由器之间沟通网络层**的信息。ICMP最典型的作用是**差错和异常情况报告**，HTTP会话时，目的网络不可达的错误报告，就是ICMP报文。

ICMP在IP之上，**ICMP是作为IP有效载荷承载的**。

ICMP报文有一个典型字段和一个编码字段，并且包含引起该ICMP报文首次生成的IP数据报的首部和前8个字节(以便发送方能确定引发该差错的数据报)。

ping程序就是发送一个**ICMP类型8编码0**的报文到指定主机。大多数TCP/IP实现直接在操作系统中支持ping服务器，即该服务器不是一个进程。

源抑制报文，



| ICMP类型 | 编码 | 描述                          |
| -------- | ---- | ----------------------------- |
| 0        | 0    | 回显回答(对ping的回答)        |
| 3        | 0    | 目的网络不可达                |
| 3        | 1    | 目的主机不可达                |
| 3        | 2    | 目的协议不可达                |
| 3        | 3    | 目的端口不可达                |
| 3        | 6    | 目的网络未知                  |
| 3        | 7    | 目的主机未知                  |
| 4        | 0    | 源抑制Source quench(拥塞控制) |
| 8        | 0    | 回显请求                      |
| 9        | 0    | 路由器通告                    |
| 10       | 0    | 路由器发现                    |
| 11       | 0    | TTL过期                       |
| 12       | 0    | IP首部损坏                    |

**traceroute是通过ICMP报文实现**的。源主机中的traceroute向目的主机发送**一系列**的IP数据报，每个都携带了一个具有不可达UDP端口号的UDP报文，第一个报文段的TTL为1，第二个TTL为2，依次类推。当第n个数据报到达din台路由器时，就会刚好过期。路由器就会发送一个ICMP警告报文给源主机。**警告报文包括了路由器的名字和它的IP地址**。此外还会知道两台主机之间的往返时延。

# 十、网络管理和SNMP

网络管理在执行任务中使用的体系结构、协议和信息库。

## 1、网络管理框架

网络管理的组件：管理服务器、被管设备、MIB数据、远程代理、SNMP

* 管理服务器(manager server)
  * 是应用程序，运行在运营中心(NOC)的集中式网络管理工作站中。管理服务器是执行网络管理活动的地方，控制网络管理信息的收集、处理、分析和显示
* 被管设备(managed device)
  * 被管对象是硬件的实际部分和利用于这些硬件及软件组件的实际参数
* 管理信息库(management information base, MIB)
  * 一个计数器，例如由于IP数据报首部差错而路由器丢弃的IP数据报的数量；运行在一台DNS服务器上的软件版本的描述性信息
  * 总的来说就是收集被管对象的关联信息
* 网络管理代理(network management agent)
  * 运行在被管设备的一个进程，进程于管理服务器通信，在管理服务器的命令下在被管设备中控制被管设备的本地动作。
* 网络管理协议(network management protocol)
  * 允许管理服务器查询被管对象的状态，并通过代理间接地采取行动

## 2、简单网络管理协议

Simple Network Management Protocol。是一个应用层协议，用于在管理服务器和代理之间传递网络管理控制和信息报文。

最常用的是**请求响应模式**。请求通常用于查询(检索)或修改(设置)与某被管设备关联的MIB对象值。第二个常用的是代理向管理服务器发送一个非请求报文，称为**陷阱报文(trap message)**，陷阱报文用于通知管理服务器，一个异常情况已经导致了MIB对象值的改变。

| SNMPv2PDU类型  | 发送方-接收方       | 描述                            |
| -------------- | ------------------- | ------------------------------- |
| GetRequest     | 管理者-代理         | 取得一个或多个MIB对象的实例值   |
| GetNextRequest | 管理者-代理         | 取得列表下一个MIB对象实例值     |
| GetBulkRequest | 管理者-代理         | 以大数据块方式取得值            |
| InformRequest  | 管理者-管理者       | 向不能访问远程管理实体通知MIB值 |
| SetRequest     | 管理者-代理         | 设置一个或多个MIB对象实例的值   |
| Response       | 代理or管理者-管理者 |                                 |
| SNMPv2-Trap    | 代理-管理者         | 通知一个异常事件                |

