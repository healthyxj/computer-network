![数据包的传输过程](https://github.com/healthyxj/computer-network/blob/main/img/%E6%95%B0%E6%8D%AE%E5%8C%85%E7%9A%84%E4%BC%A0%E8%BE%93%E8%BF%87%E7%A8%8B.jpg)

路由器连接不同网段时，第一次超时的原因是，源主机发送第一个包时，路由器处理不过来，就丢包，但是能够往目的主机发送一个ARP广播，这样子就能够获得目的主机的MAC地址。

| 层数 |         名称          |            协议            |    数据名称     | 数据表示 |
| :--: | :-------------------: | :------------------------: | :-------------: | :------: |
|  5   |  应用层(Application)  | FTP、HTTP、SMTP、DNS、DHCP |  报文(Message)  |    5     |
|  4   |   运输层(Transport)   |          TCP、UDP          | 数据段(Segment) |    45    |
|  3   |    网络层(Network)    |       IP、ARP、ICMP        |   包(Packet)    |   345    |
|  2   | 数据链路层(Data Link) |        CSMA/CD、PPP        |  数据帧(Frame)  |  23452   |
|  1   |   物理层(Physical)    |                            |  比特流(Bits)   |  123452  |

物理层定义了接口标准、线缆标准、传输速率、传输方式

# 一、物理层的相关术语

## 1、模拟信号和数字信号

模拟信号(Analog Signal)是<b>连续</b>的信号，<b>适合长距离传输</b>。但是<b>抗干扰能力差</b>，受到干扰时波形变形很难纠正。

数字信号(Digital Signal)是离散的信号，不适合长距离传输。抗干扰能力强，收到干扰时波形失真可以修复。

## 2、数据通信模型

![数据通信模型](https://github.com/healthyxj/computer-network/blob/main/img/%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9E%8B.jpg)



## 3、信道(channel)

信道是信息传输的通道，<b>一条传输介质上(比如一条网线)上可以有多条信道</b>。

* 单工通信
  * 信号只能往一个方向传输，任何时候都不能改变信号的传输方向
  * 如无线电广播、有线电视广播
* 半双工通信
  * 信号可以双向传输，但必须是交替进行，同一时间只能往一个方向传输
  * 如对讲机
* 全双工通信
  * 信号可以同时双向传输
  * 如手机



# 二、数据链路层的相关术语

链路：从一个节点到相邻节点的一段物理线路(有线或无线)，中间没有其他交换节点。

~~~
PC-集线器-路由器，中算只有一条链路。
~~~

在一条链路上传输数据时，需要有对应的通信协议来控制数据的传输。<b>不同类型的数据链路，使用的通信协议可能是不同的</b>。

广播信道：CSMA/CD协议(如同轴电缆、集线器等组成的网络)

点对点信道：PPP协议(如2个<b>路由器</b>之间的信道)

# 三、数据链路层的三个基本问题

## 1、封装成帧

|                    |   IP数据包   |                    |
| :----------------: | :----------: | :----------------: |
| 帧尾部(有帧结束符) | 帧的数据部分 | 帧首部(有帧开始符) |

帧的数据部分就是网络层传递下来的数据包(IP数据包，Packet)。<b>每一种数据链路层协议都规定了能够传送的帧的数据长度上限，为最大传输单元(Maximum Transfer Unit)</b>.以太网的MTU为1500字节

## 2、透明传输

数据链路层使用<b>SOH(Start of Header)作为帧开始符，使用EOT(End of Transmission)作为帧结束符</b>。

但是数据部分中一旦出现SOH或者EOT，就会造成错误。通常情况下，需要转义在原始数据中出现SOH和EOT的部分前面<b>增加ESC转义字符</b>。

## 3、差错检验

| 帧结束符 | FCS          | 帧的数据部分 | 数据链路层首部 | 帧开始符 |
| -------- | ------------ | ------------ | -------------- | -------- |
|          | 也属于帧尾部 |              | 也属于帧首部   |          |

<b>FCS是根据帧的数据部分，即来源于传输层的包(Packet)和帧首部中的数据链路层首部计算出的一个值</b>。当接收到这个帧时，也根据这两个部分计算出一个值，如果这两个值相等，证明没有出现差错。如果出错，就会丢掉这个帧。

# 四、数据链路层的协议

## 1、CSMA/CD协议

CSMA/CD(Carrier Sense Multiple Access with Collision Detectio)，载波侦听多路访问/冲突检测。

使用了CSMA/CD协议的网络可以称为是以太网(Ethernet),<b>传输的是以太网帧</b>。以太网帧的格式有Ethernet V2标准、IEEE的802.3标准。<b>使用最多的是Ethernet V2标准</b>。

为了能够检测正在发送的帧是否产生了冲突，以太网的帧<b>至少要64个字节</b>。发生冲突时，冲突的数据会返回。如果以太网帧较少，无法判断是冲突返回的还是 别人发过来的。

~~~
用交换机组建的网络，已经支持全双工通信，不需要再使用CSMA/CD，但是传输的仍然是以太网帧。
用交换机组建的网络，依然可以叫做以太网
~~~

## 2、Ethernet V2帧的格式

![Ethernet V2帧的格式](https://github.com/healthyxj/computer-network/blob/main/img/Ethernet%20V2%E5%B8%A7%E7%9A%84%E6%A0%BC%E5%BC%8F.jpg)

Ethernet V2帧<b>没有帧结束定界符，仍有FCS</b>,有插入8个字节(包括7字节的前同步码和1字节的帧开始定界符)。

剩下的统称以太网MAC帧。因为在IP包(Packet)的前面增加了<b>目标MAC地址(6字节)、源MAC地址(6字节)和类型(2字节)</b>。因此以太网MAC帧的总长度为Packet的长度+6+6+2+4(FCS的长度).

以太网使用的是曼城斯特编码，<b>接收端接收帧过程只要发现没有信号跳变，就认为帧结束</b>。

~~~
总结
以太网帧的首部：目标MAC地址+源MAC地址+网络类型(IPv4 or IPv6)
以太网帧：首部+数据+FCS
~~~

以太网帧的长度至少要64字节，所以IP的Packet至少要64-18=46字节。当数据部分小于64字节时，数据链路层会在数据后面增加一些字节填充，接收端会将填充去掉。

~~~
长度总结
以太网帧的数据长度：46-1500字节
以太网帧的长度：64-1518字节
注意区分以太网和以太网的数据部分
~~~

## 3、PPP协议(Point to Point Protocol)

路由器-路由器：PPP协议

路由器-交换机-路由器：CSMA/CD协议

|     F     |    A     |     C     | 协议  | 信息部分 |  FCS  |   F   |
| :-------: | :------: | :-------: | :---: | :------: | :---: | :---: |
| 7E，1字节 | FF,1字节 | 03，1字节 | 2字节 |          | 2字节 | 1字节 |

A是Address字段，值为0xFF。因为<b>点到点信道不需要源MAC和目标MAC地址</b>，形同虚设。广播信道CSMA/CD，因为是广播信道，需要MAC地址。

C是control字段，图中的值是0x03，目前没什么作用

Protocol字段：内部用到的协议类型

帧开始符、帧结束符：0x7E。同样为了透明传输，需要<b>将数据部分中的0x7E替换成0x7D5E,将0x7D替换成0x7D5D</b>

网卡接收到一个帧，首先会进行<b>差错校验，如果校验通过则接收，否则丢弃</b> Wireshark抓到的帧没有FCS ，因为它抓到的是<b>差错校验通过的帧（帧尾的FCS会被硬件去掉）</b>

Wireshark抓不到差错校验失败的帧

集线器工作在物理层；路由器工作在三层
