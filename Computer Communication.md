# 一、通信基础
一开始是得知对方的<b>IP地址</b>。

最终是根据<b>MAC地址(网卡地址)</b>，输送数据到网卡，被网卡接收。如果网卡发现数据的目标MAC地址是自己，就会将数据传递给上一层进行处理；<b>如果目标MAC地址不是自己，会将数据丢弃，不会传递给上一层</b>。

一个网卡一个MAC地址，获取MAC地址后，会存入，成为ARP缓存

# 二、计算机之间的连接方式
为便于理解，使用Packet Tracer进行模拟仿真。

一些常用的英文单词：switch交换机，router路由器，hub集线器

## 1、网线直连(交叉线)
选中end devices(终端设备)-PC，在工作区放置两台PC。再选中闪电形状的link(连接)，闪电形状是默认生成的。双击PC，打开计算机相关的内容，选中桌面，IP配置。IPv4，填入192.168.1.10，子网掩码按下tab键就自动生成。关闭就算保存了。另一台IP地址设为192.168.1.11.然后在第一台PC上，打开桌面-命令提示符，输入ping 192.168.1.11.能发现能够ping通

点击仿真，将左上角的PDU拖到一个PC上，再点击另一台PC，就会发现能够发送数据包。在右侧的仿真点击计算机，就能看到OSI模型上的内容。实际上，是因为<b>第一次ping通之后，记住了另一台PC的MAC地址</b>。获取的MAC地址会存入ARP缓存中。

如果只知道IP地址，不知道MAC地址，就会<b>采用ARP协议，发送一个广播</b>。广播是<b>在同一个网段中传播</b>的，不同网段之间是不能传播的。发送广播的目的，是知道目的主机的MAC地址。MAC地址若为<b>FFFF.FFFF.FFFF</b>，表示是全1，即为广播。

## 2、同轴电缆(coaxial)
同轴电缆用于连接多台PC。

特点

* 半双工通信：同一时间只允许一个方向发送数据
* 容易冲突：两台及以上的PC发送请求时，会造成冲突
* 不安全
* 中间断了，网络就坍了

## 3、集线器(hub)
集线器之间可以互相连接来增加连接数目。

特点

* 半双工通信
* 容易冲突
* 不安全
* 跟同轴电缆一样，没有智商

~~~
可以通过arp -a查看当前PC存储的arp缓存，arp缓存记录了缓存主机的IP地址和MAC地址
~~~

## 4、 网桥(bridge)
同样连接同一网段

能够<b>通过自学习得知每个接口那侧的MAC地址</b>，从而起到隔绝冲突域的作用。隔绝冲突域的意思是在网桥的两侧，如果同时发送请求，不会产生冲突。

但是接口少

## 5、交换机(switch)
交换机相当于接口更多的网桥，<b>交换机≈集线器+网桥</b>

全双工通信

二层交换机无IP地址，三层交换机有IP地址

<b>组建局域网，需要交换机。</b>

~~~
网线直连、同轴电缆、集线器、网桥、交换机
连接的设备需要在同一网段
连接的设备要在同一广播域，广播域意味着某一台机器发了一个广播，同一网段的机器都能够收到

路由器
可以在不同网段之间转发数据
隔绝广播域
~~~

## 6、路由器(router)
主机发送请求之前，首先要判断<b>目标主机的IP地址是否与该主机在同一网段</b>

* 若在<b>同一网段上，则通过ARP协议</b>，经过集线器、交换机等设备传递数据

* 若<b>不在同一网段上，则通过路由器</b>转发数据

路由器连接几个网段，就有几个网关，<b>网关与所连的广播域的网段相同</b>,源主机需要配置默认网关(网段最后位为1)

### 具体流程

假如路由器一端的主机要发送数据到另一端的主机，首先源主机先发送一个arp广播，该广播发送到路由器的IP地址后，路由器把自身的的MAC地址发送回源主机。源主机得知了MAC地址后，就发送数据。数据到达路由器后，由路由器发送arp广播，arp广播到达目标主机后，目标主机发送MAC地址会路由器，最终传递回源主机。

通过packet tracer查看路由器的端口，在菜单栏选择选项-首选项-在逻辑工作区总是显示端口标签。点击路由器，选择物理，可以看到有快速以太网(FastEthernet)、串口(serial)

# 三、IP地址、子网掩码与默认网关
## 1、MAC地址
每一个网卡都有一个6字节的MAC地址(Media Access Control Address)。每个网卡的MAC地址都唯一，固化在网卡的ROM中，由IEEE802标准规定。<b>前三个字节为OUI(Organization Unique Identifier)，组织标识符</b>，由IEEE的注册管理机构分配给厂商；后3个字节是网络接口标识符，由厂商自行分配。

windows是杠隔开，类unix系统是由冒号隔开。48位全为1时，即FF-FF-FF-FF，代表广播地址。

查看MAC地址，ipconfig -all

修改MAC地址：点击打开“网络和Internet”设置-更改适配器选项-属性-配置-高级-网络地址，修改不存在为值，填写值的时候要将-去掉。

有时可以通过修改MAC地址进行蹭网。

arp -d 删除ARP缓存中的所有内容

## 2、IP地址
IP地址(Internet Protocol Address)：互联网上每一个主机都有一个IP地址。最初是IPv4版本，32bit(4字节)，但是不够用，就推出了IPv6版本，128bit(16字节)

不指定版本，默认是IPv4版本，后面再单独讨论IPv6版本。

<b>按字节(1字节有8个二进制位)来分，可以分为4部分</b>，即192.168.1.10

IP地址：192.168.1.10

子网掩码：255.255.255.0

IP地址由网络ID和主机ID组成,网络ID与主机ID的区分关系到网段。

<b>网段是IP地址&子网掩码</b>,

  1100 0000.1010 1000.0000 0001.0000 1010

&1111 1111.1111 1111.1111 1111.0000 0000

---

  1100 0000.1010 1000.0000 0001.0000 0000

即网段为192.168.1.0，所以192.168.1为网络ID，10为主机ID。IP地址的<b>主机位不能全部为0或者全部为1(这里指二进制位，换算一下就是255)</b>

如果要跨网段发送数据，就需要网关。路由器上的IP配置就是网关，<b>网关末位最好设置为1</b>,不容易超时。

### IP地址分类

A类地址，默认子网掩码为255.0.0.0；后24位为主机ID，<b>网络ID以0开头</b>，所以<b>网络ID部分为0-127</b>，127.0.0.1为本地环回地址(lookback)，代表本机地址

B类地址：默认子网掩码为255.255.0.0；后18位为主机标识，<b>网络ID要以10开头</b>，所以网络ID部分为128-191.0-255，

C类地址：默认子网掩码为255.255.255.0，<b>网络ID必须以110开头</b>，所以网络ID为192-223.0-255.0-255

D类地址：以1110开头，为多播地址，224-239

E类地址：以1111开头，保留为今后使用，240-255

只有ABC类地址才会分配给主机。网段处为255，表示广播段。<b>默认不代表一定，可以随具体情况改变。</b>

## 3、子网掩码
子网掩码的CIDR表示方法，CIDR(Classless Inter-Domain Routing):无类别域间路由

<b>192.168.1.100/24,表示子网掩码有24个1</b>，即255.255.255.0

进行子网划分的原因

要让500台主机在同一网段内，分配一个C类网段肯定是不可行的，起码得B类网段。但是B类网段有65536-2个，造成了网段的浪费。这种情况下就可以采用子网划分，借助主机位作子网维，划分出多个子网。

### 等长子网划分（重点！！！！！！）

本来的C类网段：192.168.0.0/24 划分成2个子网段

从主机位拿出一位最高位当作网络ID，即

A子网：192.168.0.0000 0000->192.168.0.0/25

B子网：192.168.0.1000 0000->192.168.0.128/25

此时的<b>子网掩码均为255.255.255.128</b>，A的主机位为1-126，B的主机位为129-254

等分成4个子网，子网掩码往后移动2位。

<b>网关跟主机位类似，必须为合理的IP地址</b>，因此A网管可以设置为192.168.0.1，B网关可以设置为192.168.0.129

<b>注意区分网段与子网段</b>

10.172.168.1/8 A类网段

10.172.168.1/16A类子网段

~~~
建议从子网掩码入手
划分子网段时，先确定子网掩码。若划分为两个子网段，则从主机位拿出一位。一个为0，一个为1，确定两个主机IP地址的范围.将拿来的主机位全部置1，从而确定两个主机的子网掩码(这些主机的子网掩码应该是相同的)。
子网掩码确定后，选择中间的数作为主机位，从而获得主机的IP地址。一般选择IP地址对应的网段加1作为默认网关。

设置路由器(网关)
路由器的子网掩码同样设置为给出的主机位全部置1时的子网掩码。路由器的IP地址设置为对应侧的末位+1的网段。
~~~

2子网段的连接
|          |       PC1       |    路由器fa0    |    路由器fa1    |       PC2       |
| :------: | :-------------: | :-------------: | :-------------: | :-------------: |
|  IP地址  |  192.168.0.11   |   192.168.0.1   |  192.168.0.129  |  192.168.0.130  |
| 子网掩码 | 255.255.255.128 | 255.255.255.128 | 255.255.255.128 | 255.255.255.128 |
| 默认网关 |   192.168.0.1   |                 |                 |  192.168.0.129  |

在Packet Tracer上模拟时，注意要将端口状态设置为开。

A子网的网段为19.168.0.0；B子网的网段为192.168.0.128

### 变长子网划分

<b>如果一个子网地址块的长度为原网段的(1/2)^n，那么子网的子网掩码就是在原网段的子网掩码基础上增加n个1</b>。不等长的子网，子网掩码必不同。

| 0-4   | 4-8   | 8-16 | 16-32 | 32-64 | 64-128 | 128-255 |
| ----- | ----- | ---- | ----- | ----- | ------ | ------- |
| D网段 | E网段 |      |       | A网段 | B网段  | C网段   |

假设是对192.168.0.0/24进行划分，则

C网段的子网掩码为255.255.255.128/25

B网段的子网掩码为255.255.255.192/26

A网段的子网掩码为255.255.255.224/27

D网段的子网掩码为255.255.255.252/30

E网段的子网掩码为255.255.255.252/30



思考题

PC1：192.168.0.10/24 与 PC2：192.168.10.10/16之间能够连通吗？

答：不能

拿PC1的子网掩码&PC2的IP地址，发现PC2的网段为

​	192.168.10.10

& 255.255.255.0

-----------------------

192.168.10.0

这个网段与PC1的网段不一致，所以PC1和PC2不能联通。虽然用PC2的子网掩码&PC1的IP地址，发现网段一致，但是要双方都一致才可以ping通。



### 超网

<b>超网是子网划分的逆过程</b>，可以将多个网段合并成一个更大的网段。

假如原来有200台计算机使用192.168.0.0/24网段，现在希望增加200台设备到同一网段。

200台在192.168.0.0/24，200台在192.168.1.0/24，合并192.168.0.0/24、192.168.1.0/24为同一网段：192.168.0.0/23

192.168.0.0/24

192.168.1.0/24

因为是<b>逆过程，所以子网掩码左移</b>一位。即子网掩码为255.255.254.0，网段为192.168.0.0

思考

192.168.0.255/23这个IP地址，可以分配给计算机使用吗？

可以，192.168.0.255/23的网段为192.168.0.0，但是子网掩码为23位，所以后9位为主机位，0.255只有8位主机位为1，不是全部为1，可以分配给计算机使用。

合并4个网段

将子网掩码向左移动2位，可以合并4个网段，此时的子网掩码为255.255.252.0。例如可以将192.168.0.0/24、192.168.1.0/24、192.168.2.0/24、192.168.3.0/24合并为192.168.0.0/23网段

思考

下面的两个网段，能够通过子网掩码向左移动1位进行合并吗？

192.168.1.0/24和192.168.2.0/24

不能。

合并网段的规律

假设n是2的k次幂(k>=1)，则子网掩码向左移动k位能够合并n个网段。

| 初始网段                       | 子网掩码左移1位 | 子网掩码左移2位 | 子网掩码左移3位 |
| ------------------------------ | --------------- | --------------- | --------------- |
| 192.168.0.0/24与192.168.1.0/24 | 192.168.0.0/23  | 192.168.0.0/22  | 192.168.0.0/21  |
| 192.168.2.0/24与192.168.3.0/24 | 192.168.2.0/23  |                 |                 |
| 192.168.4.0/24与192.168.5.0/24 | 192.168.4.0/23  | 192.168.4.0/22  |                 |
| 192.168.6.0/24与192.168.7.0/24 | 192.168.6.0/23  |                 |                 |

<b>如果第一个网段的网络号能被n整除，那么由他开始连续的n个网段，都能通过左移k个子网掩码进行合并。</b>

第一个网段的网络号以二进制0结尾，那么由它开始连续的2个网段，能通过左移1位子网掩码进行合并。如192.168.0.0/24与192.168.1.0/24

第一个网段的网络号以二进制00结尾，那么由它开始连续的4个网段，能通过左移2位子网掩码进行合并。如192.168.4.0/24到192.168.7.0/24 

第一个网段的网络号以二进制000结尾，那么由它开始连续的8个网段，能通过左移3位子网掩码进行合并

## 判断一个网段是子网还是超网

首先，看网段的类型，A类、B类还是C类？

然后根据默认的子网掩码的位数进行判断，如果，该网段的子网掩码数比默认的子网掩码多，就是子网，否则就是超网。

例如25.100.0.0/16是A类子网

# 四、路由

在不同网段之间转发数据，需要有路由器的支持。默认情况下，路由器只知道跟他直连的网段，<b>非直连的网段需要通过静态路由、动态路由</b>来告诉他。

静态路由

* 管理员手动添加路由信息
* 适用于小规模

动态路由

* 路由器通过路由器选择协议(RIP\OSPF)自动获取
* 适用于大规模网络



PRACTICE

让4个不同网段的PC能够相互通信

主要是对两台路由器进行静态路由的配置。首先，找到路由器的串口(串口也类似于一个网卡)，<b>使不同路由器的串口，在同一网段上</b>。因此4台PC，总共有5个网段。串口都打开，才会变绿。

然后，给不同的路由器添加静态路由。静态路由的网络栏填要连通的<b>网段</b>(便于后续添加新的PC不用修改)，掩码栏填要联通的网段的子网掩码，<b>下一跳栏填连通网段的路由器的串口地址</b>。

如果只是想连通特定的网络，可以在网络栏填上具体PC的IP地址，子网掩码填255.255.255.255，

<b>为了少修改，可以减少子网掩码中1的个数</b>，原理类似于超网。甚至默认路由，<b>只要不知道下一个网段怎么走，都可以用默认路由。网络填0.0.0.0，子网掩码填0.0.0.0.</b>但是下一跳不能填0.0.0.0
## 常用的几种接口

* FastEthernet 快速以太网接口(100M)，

* GigabitEthernet 千兆以太网口
* Serial 串口

# 五、公网IP、私网IP

IP地址分为公网IP和私网IP

## 公网IP(Public)

Internet上的<b>路由器只有到达公网的路由表，没有到达私网的路由表</b>。公网IP由因特网信息中心(Internet Network Information，inter NIC)统一分配和管理。ISP需要向inter NIC申请公网IP。

## 私网IP(Private)

主要用于局域网。保留的私网网段有

* A类：10.0.0.0/8，1个A类网络
* B类：172.16.0.0/16~172.31.0.0/16，16个B类网络
* C类：<b>192.168.0.0/24~192.168.255.0/24</b>，256个C类网络

## NAT

192.168.1.10属于私网，大多数人自己ipconfig得到的都是这个网段。

实际上，<b>私网IP访问Internet需要进行NAT转化为公网IP</b>，NAT(Network Address Translation)，这一步由路由器来完成。

NAT特点：可以节约公网IP资源，会隐藏内部真实IP

NAT分类

* 静态转换
  * 需要手动配置NAT映射表
  * 一对一转换，因此不实用
* 动态转换
  * 定义外部地址池，动态随机转换
  * 一对一转换
* <b>PAT(Port Address Translation)</b>
  * 多对一转换，最大程度节约公网IP
  * 端口多路复用方式，通过端口号标识不同的数据流
  * 是目前最广泛的NAT实现方式

| 192.168.1.10:23123 | ->   | 200.0.0.10:23123 |
| ------------------ | ---- | ---------------- |
| 192.168.1.11:7676  | ->   | 200.0.0.10:7676  |
| 192.168.1.12:7676  | ->   | 200.0.0.10:64565 |


